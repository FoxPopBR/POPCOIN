{% extends "base.html" %}

{% block title %}PopCoin IDLE - In√≠cio{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <section class="hero-section fade-in">
        <h1>üéÆ PopCoin IDLE</h1>
        <p class="subtitle">Clique, colete moedas e evolua seu imp√©rio digital!</p>
        
        <div class="features">
            <div class="feature">
                <span class="feature-icon">ü™ô</span>
                <h3>Colete Moedas</h3>
                <p>Clique na moeda para ganhar PopCoins e construir sua fortuna</p>
            </div>
            
            <div class="feature">
                <span class="feature-icon">‚ö°</span>
                <h3>Fa√ßa Upgrades</h3>
                <p>Melhore seu clique e gere moedas autom√°ticas 24/7</p>
            </div>
            
            <div class="feature">
                <span class="feature-icon">üèÜ</span>
                <h3>Desbloqueie Conquistas</h3>
                <p>Complete desafios √©picos e mostre seu progresso</p>
            </div>
        </div>
    </section>

    <!-- Se√ß√£o para usu√°rios logados -->
    <div id="game-section" class="hidden">
        <div class="auth-card text-center">
            <h2>üéâ Bem-vindo de volta!</h2>
            <p>Seu imp√©rio aguarda por voc√™. Continue sua jornada!</p>
            <div class="action-buttons">
                <!-- ‚úÖ CORRE√á√ÉO: Mudar de /game para /profile como a√ß√£o principal -->
                <a href="{{ url_for('profile') }}" class="btn btn-primary btn-large">
                    üë§ Ir para Meu Perfil
                </a>
                <!-- ‚úÖ CORRE√á√ÉO: Manter jogo como a√ß√£o secund√°ria -->
                <a href="{{ url_for('game') }}" class="btn btn-secondary">
                    üéÆ Continuar Jogando
                </a>
            </div>
        </div>
    </div>
    
    <!-- Se√ß√£o de boas-vindas para novos usu√°rios -->
    <div id="welcome-section">
        <div class="auth-card">
            <h2>üöÄ Comece Sua Jornada</h2>
            <p class="mb-2">Junte-se a milhares de jogadores e construa seu imp√©rio de moedas!</p>
            
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Entrar</button>
                <button class="auth-tab" data-tab="register">Cadastrar</button>
            </div>
            
            <!-- Formul√°rio de Login -->
            <div id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-email">E-mail:</label>
                    <input type="email" id="login-email" placeholder="seu@email.com" autocomplete="email" required>
                </div>
                
                <div class="form-group">
                    <label for="login-password">Senha:</label>
                    <input type="password" id="login-password" placeholder="Sua senha" autocomplete="current-password" required>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="handleEmailLogin()">
                    üîê Entrar com E-mail
                </button>
                
                <div class="form-options">
                    <button type="button" class="btn-link" onclick="handleResetPassword()">
                        üîë Esqueci minha senha
                    </button>
                </div>
                
                <div class="separator">
                    <span>ou</span>
                </div>
                
                <button type="button" class="btn btn-google" onclick="handleGoogleLogin()">
                    <span class="btn-icon">üîó</span>
                    Entrar com Google
                </button>
            </div>
            
            <!-- Formul√°rio de Registro -->
            <div id="register-form" class="auth-form hidden">
                <div class="form-group">
                    <label for="register-name">Nome completo:</label>
                    <input type="text" id="register-name" placeholder="Seu nome completo" autocomplete="name" required>
                </div>
                
                <div class="form-group">
                    <label for="register-email">E-mail:</label>
                    <input type="email" id="register-email" placeholder="seu@email.com" autocomplete="email" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password">Senha:</label>
                    <input type="password" id="register-password" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password" minlength="6" required>
                    <div class="password-strength" id="password-strength">
                        <div class="strength-bar"></div>
                        <span class="strength-text">For√ßa da senha</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="register-confirm">Confirmar senha:</label>
                    <input type="password" id="register-confirm" placeholder="Digite novamente" autocomplete="new-password" required>
                    <div class="password-match" id="password-match"></div>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="handleEmailRegister()">
                    üìù Criar Conta
                </button>
                
                <div class="separator">
                    <span>ou</span>
                </div>
                
                <button type="button" class="btn btn-google" onclick="handleGoogleLogin()">
                    <span class="btn-icon">üîó</span>
                    Cadastrar com Google
                </button>
            </div>
            
            <div class="game-preview mt-2">
                <h4>üéØ O que voc√™ ganha:</h4>
                <ul class="benefits-list">
                    <li>‚úÖ Progresso salvo na nuvem</li>
                    <li>‚úÖ Ganhos autom√°ticos offline</li>
                    <li>‚úÖ Sistema de conquistas exclusivas</li>
                    <li>‚úÖ Upgrades e evolu√ß√£o cont√≠nua</li>
                    <li>‚úÖ Multiplicadores de prest√≠gio</li>
                    <li>‚úÖ Ranking com outros jogadores</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Sistema de abas
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Inicializando sistema de abas...');
    
    const tabs = document.querySelectorAll('.auth-tab');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            console.log(`üìë Alternando para aba: ${tabName}`);
            
            // Ativar aba clicada
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Mostrar formul√°rio correspondente
            if (tabName === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
        });
    });

    // Configurar valida√ß√£o de senha em tempo real
    const registerPassword = document.getElementById('register-password');
    const registerConfirm = document.getElementById('register-confirm');
    
    if (registerPassword) {
        registerPassword.addEventListener('input', checkPasswordStrength);
    }
    
    if (registerConfirm) {
        registerConfirm.addEventListener('input', checkPasswordMatch);
    }

    // Enter key nos formul√°rios
    setupEnterKeyListeners();
});

// Sistema de atualiza√ß√£o de UI para a p√°gina inicial
function updatePageSections() {
    const gameSection = document.getElementById('game-section');
    const welcomeSection = document.getElementById('welcome-section');
    
    if (window.authManager && window.authManager.isAuthenticated) {
        console.log('‚úÖ Usu√°rio autenticado, mostrando se√ß√£o do jogo');
        if (gameSection) gameSection.classList.remove('hidden');
        if (welcomeSection) welcomeSection.classList.add('hidden');
    } else {
        console.log('üîê Usu√°rio n√£o autenticado, mostrando se√ß√£o de boas-vindas');
        if (gameSection) gameSection.classList.add('hidden');
        if (welcomeSection) welcomeSection.classList.remove('hidden');
    }
}

// Observar mudan√ßas no estado de autentica√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç Configurando observador de autentica√ß√£o...');
    
    const checkAuthReady = setInterval(() => {
        if (window.authManager) {
            clearInterval(checkAuthReady);
            console.log('‚úÖ AuthManager detectado, configurando observador...');
            
            // Observar mudan√ßas no estado de autentica√ß√£o
            window.addEventListener('authStateChanged', function(event) {
                console.log('üîÑ Evento de mudan√ßa de auth detectado:', event.detail);
                updatePageSections();
            });
            
            // Atualizar inicialmente
            updatePageSections();
        }
    }, 100);
});

// Valida√ß√£o de for√ßa da senha
function checkPasswordStrength() {
    const password = document.getElementById('register-password').value;
    const strengthBar = document.querySelector('.strength-bar');
    const strengthText = document.querySelector('.strength-text');
    
    if (!password) {
        strengthBar.style.width = '0%';
        strengthBar.style.background = '#ddd';
        strengthText.textContent = 'For√ßa da senha';
        return;
    }
    
    let strength = 0;
    if (password.length >= 6) strength += 25;
    if (password.length >= 8) strength += 25;
    if (/[A-Z]/.test(password)) strength += 25;
    if (/[0-9]/.test(password)) strength += 25;
    
    strengthBar.style.width = strength + '%';
    
    if (strength < 50) {
        strengthBar.style.background = '#dc3545';
        strengthText.textContent = 'Fraca';
    } else if (strength < 75) {
        strengthBar.style.background = '#ffc107';
        strengthText.textContent = 'M√©dia';
    } else {
        strengthBar.style.background = '#28a745';
        strengthText.textContent = 'Forte';
    }
}

// Valida√ß√£o de confirma√ß√£o de senha
function checkPasswordMatch() {
    const password = document.getElementById('register-password').value;
    const confirm = document.getElementById('register-confirm').value;
    const matchDiv = document.getElementById('password-match');
    
    if (!confirm) {
        matchDiv.innerHTML = '';
        return;
    }
    
    if (password === confirm) {
        matchDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Senhas coincidem</span>';
    } else {
        matchDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Senhas n√£o coincidem</span>';
    }
}

// Configurar listeners para tecla Enter
function setupEnterKeyListeners() {
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const registerName = document.getElementById('register-name');
    const registerEmail = document.getElementById('register-email');
    const registerPassword = document.getElementById('register-password');
    const registerConfirm = document.getElementById('register-confirm');
    
    // Login form
    if (loginPassword) {
        loginPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleEmailLogin();
            }
        });
    }
    
    // Register form
    if (registerConfirm) {
        registerConfirm.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleEmailRegister();
            }
        });
    }
}

// Fun√ß√µes de handler CORRETAS - usando o authManager diretamente
function handleEmailLogin() {
    console.log('üîê Iniciando login com email...');
    
    if (!window.authManager) {
        showAuthError('Sistema de autentica√ß√£o n√£o carregado. Recarregue a p√°gina.');
        return;
    }
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        showAuthError('Por favor, preencha email e senha.');
        return;
    }
    
    if (!isValidEmail(email)) {
        showAuthError('Por favor, insira um email v√°lido.');
        return;
    }
    
    window.authManager.loginWithEmail();
}

function handleEmailRegister() {
    console.log('üìù Iniciando registro com email...');
    
    if (!window.authManager) {
        showAuthError('Sistema de autentica√ß√£o n√£o carregado. Recarregue a p√°gina.');
        return;
    }
    
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const confirm = document.getElementById('register-confirm').value;
    
    // Valida√ß√µes
    if (!name || !email || !password || !confirm) {
        showAuthError('Por favor, preencha todos os campos.');
        return;
    }
    
    if (!isValidEmail(email)) {
        showAuthError('Por favor, insira um email v√°lido.');
        return;
    }
    
    if (password !== confirm) {
        showAuthError('As senhas n√£o coincidem.');
        return;
    }
    
    if (password.length < 6) {
        showAuthError('A senha deve ter pelo menos 6 caracteres.');
        return;
    }
    
    window.authManager.registerWithEmail();
}

function handleGoogleLogin() {
    console.log('üîó Iniciando login com Google...');
    
    if (!window.authManager) {
        showAuthError('Sistema de autentica√ß√£o n√£o carregado. Recarregue a p√°gina.');
        return;
    }
    
    window.authManager.loginWithGoogle();
}

function handleResetPassword() {
    console.log('üîë Solicitando redefini√ß√£o de senha...');
    
    if (!window.authManager) {
        showAuthError('Sistema de autentica√ß√£o n√£o carregado. Recarregue a p√°gina.');
        return;
    }
    
    // Tentar pegar email do formul√°rio de login primeiro
    const loginEmail = document.getElementById('login-email').value;
    const registerEmail = document.getElementById('register-email').value;
    
    let email = loginEmail || registerEmail;
    
    if (!email) {
        email = prompt('Digite seu e-mail para redefinir a senha:');
        if (!email) {
            showAuthError('Por favor, insira um email.');
            return;
        }
    }
    
    if (!isValidEmail(email)) {
        showAuthError('Por favor, insira um email v√°lido.');
        return;
    }
    
    window.authManager.resetPassword();
}

// Fun√ß√µes utilit√°rias
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function showAuthError(message) {
    console.error('‚ùå Erro de autentica√ß√£o:', message);
    
    // Usar sistema de mensagens do authManager se dispon√≠vel
    if (window.authManager && window.authManager.showMessage) {
        window.authManager.showMessage(message, 'error');
    } else {
        // Fallback: alert simples
        alert(message);
    }
}

// Expor fun√ß√µes globalmente para os onclick
window.handleEmailLogin = handleEmailLogin;
window.handleEmailRegister = handleEmailRegister;
window.handleGoogleLogin = handleGoogleLogin;
window.handleResetPassword = handleResetPassword;

// Inicializa√ß√£o adicional quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('üè† P√°gina inicial carregada e configurada');
    
    // Focar no primeiro campo do formul√°rio ativo
    setTimeout(() => {
        const activeForm = document.querySelector('.auth-form:not(.hidden)');
        if (activeForm) {
            const firstInput = activeForm.querySelector('input[type="email"], input[type="text"]');
            if (firstInput) {
                firstInput.focus();
            }
        }
    }, 500);
});
</script>

<style>
/* Estilos espec√≠ficos para a p√°gina inicial */
.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.btn-link {
    background: none;
    border: none;
    color: #667eea;
    cursor: pointer;
    text-decoration: underline;
    font-size: 0.9rem;
    padding: 0;
}

.btn-link:hover {
    color: #764ba2;
}

.form-options {
    text-align: center;
    margin: 1rem 0;
}

.separator {
    text-align: center;
    margin: 1.5rem 0;
    position: relative;
    color: #666;
}

.separator::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #e9ecef;
    z-index: 1;
}

.separator span {
    background: white;
    padding: 0 1rem;
    position: relative;
    z-index: 2;
    font-size: 0.9rem;
}

.password-strength {
    margin-top: 0.5rem;
}

.strength-bar {
    height: 4px;
    background: #ddd;
    border-radius: 2px;
    width: 0%;
    transition: all 0.3s ease;
}

.strength-text {
    font-size: 0.8rem;
    color: #666;
    display: block;
    margin-top: 0.25rem;
}

.password-match {
    font-size: 0.8rem;
    margin-top: 0.25rem;
    min-height: 1rem;
}

.benefits-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.benefits-list li {
    padding: 0.25rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Melhorias responsivas */
@media (max-width: 768px) {
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .action-buttons .btn {
        width: 100%;
        max-width: 250px;
    }
    
    .auth-card {
        margin: 1rem 0;
        padding: 1.5rem;
    }
    
    .features {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

@media (max-width: 480px) {
    .auth-card {
        padding: 1rem;
    }
    
    .hero-section h1 {
        font-size: 2rem;
    }
    
    .subtitle {
        font-size: 1.1rem;
    }
}

/* Anima√ß√µes suaves */
.auth-form {
    transition: all 0.3s ease;
}

.auth-tab {
    transition: all 0.3s ease;
}

.auth-tab.active {
    transform: translateY(-1px);
}

.btn {
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn:active {
    transform: translateY(0);
}

/* Estados de loading */
.btn.loading {
    opacity: 0.7;
    cursor: not-allowed;
    position: relative;
}

.btn.loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.mobile-open {
    display: flex !important;
    flex-direction: column;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--secondary-color);
    padding: 1rem;
    box-shadow: var(--shadow);
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    z-index: 1000;
}
</style>
{% endblock %}