<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PopCoin IDLE{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <style>
        /* Loading overlay fixo para toda a aplica√ß√£o */
        #global-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
            font-family: Arial, sans-serif;
            backdrop-filter: blur(5px);
        }
        
        .global-loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Melhorias no menu mobile */
        #auth-section.mobile-open {
            display: flex !important;
            flex-direction: column;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            z-index: 1000;
            gap: 1rem;
        }

        #auth-section.mobile-open .user-info,
        #auth-section.mobile-open .login-section {
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        #auth-section.mobile-open .user-avatar {
            width: 60px;
            height: 60px;
        }

        #auth-section.mobile-open .user-name {
            font-size: 1.1rem;
        }

        /* Melhorias no header */
        .header-content {
            position: relative;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: var(--white);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: rgba(255,255,255,0.2);
            font-weight: bold;
        }

        /* Responsividade melhorada */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .logo-section h1 {
                font-size: 1.5rem;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
            
            .nav-links {
                display: flex;
            }
        }

        /* Estados de loading melhorados */
        .auth-loading {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
        }

        .loading-spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 2px solid var(--white);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay Global -->
    <div id="global-loading-overlay">
        <div class="global-loading-spinner"></div>
        <h3>Processando...</h3>
        <p>Aguarde um momento</p>
    </div>

    <div id="app">
        <header class="main-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo-section">
                        <h1>üéÆ PopCoin IDLE</h1>
                    </div>
                    
                    <!-- Links de Navega√ß√£o -->
                    <nav class="nav-links" id="nav-links">
                        <a href="{{ url_for('index') }}" class="nav-link {% if request.endpoint == 'index' %}active{% endif %}">
                            üè† In√≠cio
                        </a>
                        <!-- ‚úÖ CORRE√á√ÉO: Mostrar link do jogo apenas se autenticado -->
                        <a href="{{ url_for('game') }}" class="nav-link {% if request.endpoint == 'game' %}active{% endif %} hidden" id="game-link">
                            üéÆ Jogar
                        </a>
                        <a href="{{ url_for('profile') }}" class="nav-link {% if request.endpoint == 'profile' %}active{% endif %} hidden" id="profile-link">
                            üë§ Perfil
                        </a>
                    </nav>
                    
                    <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Menu principal">
                        ‚ò∞
                    </button>
                    
                    <div id="auth-section">
                        <!-- ‚úÖ CORRE√á√ÉO: Removido o auth-loading duplicado. Agora usamos apenas o global loading -->
                        
                        <!-- Usu√°rio logado -->
                        <div id="user-info" class="hidden user-info">
                            <img id="user-pic" src="" alt="Foto do usu√°rio" class="user-avatar">
                            <span id="user-name" class="user-name"></span>
                            <div class="user-actions">
                                <a href="{{ url_for('profile') }}" class="btn-profile" id="header-profile-link">
                                    üë§ Perfil
                                </a>
                                <button id="logoutButton" class="btn-logout">üö™ Sair</button>
                            </div>
                        </div>
                        
                        <!-- Login -->
                        <div id="login-section" class="hidden login-section">
                            <button class="btn-login" onclick="handleGlobalLogin()">
                                üîë Entrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            {% block content %}{% endblock %}
        </main>

        <footer class="main-footer">
            <div class="container">
                <p>PopCoin IDLE &copy; 2024 - Desenvolvido com ‚ù§Ô∏è para jogadores ociosos</p>
                <div class="footer-links">
                    <a href="{{ url_for('index') }}">In√≠cio</a>
                    <a href="{{ url_for('game') }}">Jogar</a>
                    <a href="/privacy">Privacidade</a>
                    <a href="/terms">Termos</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_O0ur0PaP8iB_t2i6_m0WLU9C5FM4PZ4",
            authDomain: "popcoin-idle-829ae.firebaseapp.com",
            projectId: "popcoin-idle-829ae",
            storageBucket: "popcoin-idle-829ae.firebasestorage.app",
            messagingSenderId: "337350823197",
            appId: "1:337350823197:web:4928ae4827e21c585da5f4"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    {% block scripts %}{% endblock %}

    <script>
        // Menu Mobile e funcionalidades globais
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const authSection = document.getElementById('auth-section');
            const navLinks = document.getElementById('nav-links');
            
            // Menu Mobile
            if (mobileMenuBtn && authSection) {
                mobileMenuBtn.addEventListener('click', function() {
                    authSection.classList.toggle('mobile-open');
                    navLinks.classList.toggle('mobile-open');
                    this.classList.toggle('active');
                });
            }

            // Fechar menu ao clicar fora
            document.addEventListener('click', function(event) {
                if (!event.target.closest('#auth-section') && !event.target.closest('#mobileMenuBtn')) {
                    authSection.classList.remove('mobile-open');
                    navLinks.classList.remove('mobile-open');
                    mobileMenuBtn.classList.remove('active');
                }
            });

            // Configura√ß√£o global de loading
            window.showGlobalLoading = function(message = 'Processando...') {
                const overlay = document.getElementById('global-loading-overlay');
                if (overlay) {
                    overlay.querySelector('h3').textContent = message;
                    overlay.style.display = 'flex';
                }
            };
            
            window.hideGlobalLoading = function() {
                const overlay = document.getElementById('global-loading-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            };

            // ‚úÖ CORRE√á√ÉO: Atualizar navega√ß√£o baseada no estado de autentica√ß√£o
            function updateNavigation(isAuthenticated) {
                const profileLink = document.getElementById('profile-link');
                const gameLink = document.getElementById('game-link');
                const headerProfileLink = document.getElementById('header-profile-link');
                
                if (isAuthenticated) {
                    // Mostrar links para perfil e jogo
                    if (profileLink) profileLink.classList.remove('hidden');
                    if (gameLink) gameLink.classList.remove('hidden');
                    if (headerProfileLink) headerProfileLink.style.display = 'block';
                } else {
                    // Ocultar links para perfil e jogo
                    if (profileLink) profileLink.classList.add('hidden');
                    if (gameLink) gameLink.classList.add('hidden');
                    if (headerProfileLink) headerProfileLink.style.display = 'none';
                }
            }

            // Prevenir envio de formul√°rios com Enter
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && event.target.tagName === 'INPUT') {
                    const form = event.target.closest('form');
                    if (form && !form.querySelector('button[type="submit"]')) {
                        event.preventDefault();
                    }
                }
            });
        });

        // Fun√ß√£o global de login
        function handleGlobalLogin() {
            if (window.authManager && window.authManager.loginWithGoogle) {
                window.authManager.loginWithGoogle();
            } else {
                showGlobalLoading('Carregando...');
                setTimeout(() => {
                    if (window.authManager && window.authManager.loginWithGoogle) {
                        window.authManager.loginWithGoogle();
                    } else {
                        hideGlobalLoading();
                        alert('Sistema de autentica√ß√£o n√£o carregado. Recarregue a p√°gina.');
                    }
                }, 1000);
            }
        }

        // Expor fun√ß√£o globalmente
        window.handleGlobalLogin = handleGlobalLogin;

        // Web Vitals e m√©tricas de performance
        if ('visibilityState' in document) {
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    // Salvar estado quando a p√°gina for ocultada
                    if (window.game && window.game.saveGameState) {
                        window.game.saveGameState(true);
                    }
                }
            });
        }

        // Tratamento de erros global
        window.addEventListener('error', function(event) {
            console.error('Erro global capturado:', event.error);
            
            // N√£o mostrar alertas para erros de rede ou recursos n√£o cr√≠ticos
            if (event.error && !event.error.message.includes('Loading') && 
                !event.error.message.includes('Network') &&
                !event.error.message.includes('timeout')) {
                
                if (window.authManager && window.authManager.showMessage) {
                    window.authManager.showMessage('Ocorreu um erro inesperado. A p√°gina ser√° recarregada.', 'error');
                }
                
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        });

        // Prevenir a√ß√µes duplas
        function preventMultipleActions(element, timeout = 1000) {
            if (element.disabled) return false;
            element.disabled = true;
            setTimeout(() => {
                element.disabled = false;
            }, timeout);
            return true;
        }

        // Expor utilit√°rios globalmente
        window.preventMultipleActions = preventMultipleActions;
    </script>
    <script>
    // Fallback para avatar padr√£o
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ Configurando fallback para avatares...');
        
        const setDefaultAvatar = function(img) {
            console.log('üñºÔ∏è Aplicando fallback para avatar:', img.id || img.className);
            img.onerror = null;
            // SVG de avatar padr√£o em base64
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNjAiIHI9IjYwIiBmaWxsPSIjRjBGMEYwIi8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNDUiIHI9IjI1IiBmaWxsPSIjQ0NDIi8+CjxyZWN0IHg9IjMwIiB5PSI3MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjUwIiByeD0iMjAiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+';
        };
        
        // Aplicar a todos os avatares
        const avatars = document.querySelectorAll('#user-pic, #profile-avatar-img, .user-avatar');
        console.log(`üë§ Encontrados ${avatars.length} avatares na p√°gina`);
        
        avatars.forEach(avatar => {
            if (!avatar.src || avatar.src.includes('default-avatar')) {
                setDefaultAvatar(avatar);
            }
            avatar.addEventListener('error', function() {
                console.log('‚ùå Erro ao carregar avatar, aplicando fallback');
                setDefaultAvatar(this);
            });
            
            // Verificar se o avatar j√° carregou com sucesso
            avatar.addEventListener('load', function() {
                console.log('‚úÖ Avatar carregado com sucesso:', this.src);
            });
        });
    });
    </script>

</body>
</html>